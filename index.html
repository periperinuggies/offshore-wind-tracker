<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <title>Offshore Wind Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .header-left {
            flex: 1;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 3px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .clear-btn {
            padding: 4px 8px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            opacity: 0.7;
        }

        .clear-btn:hover {
            opacity: 1;
        }

        /* Wizard */
        .wizard {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 500px;
            margin: 0 auto;
        }

        .wizard h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .wizard p {
            margin-bottom: 20px;
            color: #666;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-results.show {
            display: block;
        }

        .autocomplete-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-item:hover {
            background: #f5f5f5;
        }

        .spot-name {
            font-weight: 600;
            color: #333;
        }

        .spot-details {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .selected-location {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .selected-location.show {
            display: block;
        }

        .selected-location h3 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn:disabled {
            background: #ccc;
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        /* Main App */
        .app-view {
            display: none;
        }

        .search-bar-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .inline-search {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .inline-search:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        .add-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .inline-results {
            position: absolute;
            top: 100%;
            left: 10px;
            right: 10px;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: -10px;
        }

        .inline-results.show {
            display: block;
        }

        .search-bar-wrapper {
            position: relative;
        }

        .locations-scroll {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 20px 0;
            scroll-snap-type: x mandatory;
        }

        .locations-scroll::-webkit-scrollbar {
            height: 10px;
        }

        .locations-scroll::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.5);
            border-radius: 10px;
        }

        .location-card {
            min-width: 90%;
            max-width: 500px;
            background: white;
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            scroll-snap-align: center;
        }

        .card-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
        }

        .card-title {
            text-align: center;
            background: #f8f9ff;
            padding: 10px 15px;
            border-radius: 10px;
            flex: 1;
        }

        .card-title h2 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .webcam-indicator {
            font-size: 14px;
            color: #667eea;
            text-decoration: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .webcam-indicator:hover {
            transform: scale(1.2);
        }

        .card-title p {
            color: #888;
            font-size: 11px;
        }

        .card-actions {
            display: flex;
            gap: 6px;
            position: absolute;
            right: 0;
        }

        .icon-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 8px 0;
        }

        .nav-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .current-date {
            font-weight: 600;
            min-width: 140px;
            text-align: center;
            font-size: 14px;
        }

        .offshore-info {
            text-align: center;
            padding: 6px;
            background: #f0f7ff;
            border-radius: 6px;
            font-size: 11px;
            color: #555;
            margin-bottom: 8px;
        }

        .timeline {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin: 10px 0;
        }

        .hour-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .session-stars {
            position: absolute;
            left: 8px;
            font-size: 11px;
            color: #ffc107;
        }

        .time-label {
            min-width: 45px;
            font-weight: 600;
            font-size: 12px;
            text-align: right;
        }

        .wind-bar {
            flex: 1;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            color: white;
            font-weight: 600;
            position: relative;
        }

        .wind-bar .left {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .wind-bar .right {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            position: absolute;
            right: 12px;
        }

        .swell-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            line-height: 1.3;
        }

        .sun-event {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 8px 0;
            padding: 6px 10px;
            background: linear-gradient(90deg, rgba(255,193,7,0.1), rgba(255,193,7,0.2), rgba(255,193,7,0.1));
            border-left: 3px solid #ffc107;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
        }

        .sun-event:hover {
            background: linear-gradient(90deg, rgba(255,193,7,0.15), rgba(255,193,7,0.25), rgba(255,193,7,0.15));
        }

        .sun-event.sunrise {
            background: linear-gradient(90deg, rgba(255,152,0,0.1), rgba(255,193,7,0.2), rgba(255,152,0,0.1));
            border-left-color: #ff9800;
        }

        .sun-event.sunrise:hover {
            background: linear-gradient(90deg, rgba(255,152,0,0.15), rgba(255,193,7,0.25), rgba(255,152,0,0.15));
        }

        .sun-event.sunset {
            background: linear-gradient(90deg, rgba(255,87,34,0.1), rgba(255,152,0,0.2), rgba(255,87,34,0.1));
            border-left-color: #ff5722;
        }

        .sun-event.sunset:hover {
            background: linear-gradient(90deg, rgba(255,87,34,0.15), rgba(255,152,0,0.25), rgba(255,87,34,0.15));
        }

        .sun-icon {
            font-size: 18px;
        }

        .sun-label {
            font-weight: 600;
            font-size: 12px;
            color: #555;
        }

        .toggle-icon {
            position: absolute;
            font-size: 16px;
            color: #667eea;
            font-weight: bold;
        }

        .toggle-icon.left {
            left: 10px;
        }

        .toggle-icon.right {
            right: 10px;
        }

        .collapsed {
            display: none !important;
        }

        .night-period {
            opacity: 0.5;
        }

        .offshore-summary {
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .offshore-column {
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-size: 11px;
        }

        .offshore-column-title {
            font-weight: 700;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .offshore-column-time {
            font-size: 13px;
            font-weight: 600;
            margin: 3px 0;
        }

        .offshore-column-details {
            font-size: 10px;
            opacity: 0.85;
            margin-top: 2px;
        }

        .offshore-column.previous {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }

        .offshore-column.today {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .offshore-column.next {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .offshore-column.none {
            background: #f8f9fa;
            color: #adb5bd;
            border: 1px dashed #dee2e6;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 12px;
            padding: 12px;
            background: #f8f9ff;
            border-radius: 8px;
            font-size: 11px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-icon {
            font-size: 16px;
            min-width: 20px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .webcam-section {
            margin: 12px 0;
            padding: 12px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .webcam-title {
            font-weight: 600;
            font-size: 13px;
            color: #667eea;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .webcam-links {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .webcam-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #667eea;
            transition: all 0.2s;
        }

        .webcam-link:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üåä Offshore Wind</h1>
                <p>Track perfect surf conditions</p>
            </div>
            <button class="clear-btn" onclick="clearAll()">üóëÔ∏è</button>
        </div>

        <!-- Wizard -->
        <div id="wizard" class="wizard">
            <h2>Add Surf Spot</h2>
            <p id="status">Loading spots...</p>
            <div class="search-container">
                <input type="text" id="search" class="search-input" placeholder="Search (e.g., Bondi, Bells)">
                <div id="results" class="autocomplete-results"></div>
            </div>
            <div id="selected" class="selected-location">
                <h3 id="selName"></h3>
                <p><strong>Region:</strong> <span id="selRegion"></span></p>
                <p><strong>Offshore:</strong> <span id="selWind"></span></p>
            </div>
            <button class="btn" id="saveBtn" onclick="save()" disabled>Save</button>
            <button class="btn btn-secondary hidden" id="cancelBtn" onclick="cancel()">Cancel</button>
        </div>

        <!-- App -->
        <div id="app" class="app-view">
            <div class="search-bar-wrapper">
                <div class="search-bar-container">
                    <input type="text" id="inlineSearch" class="inline-search" placeholder="Search surf spots (e.g., Bondi, Bells)...">
                    <button class="add-btn" id="inlineAddBtn" onclick="addInline()" disabled>Add</button>
                </div>
                <div id="inlineResults" class="inline-results"></div>
            </div>
            <div id="cards" class="locations-scroll"></div>
        </div>

    </div>

    <script>
        const spots = [{"name":"Bondi Beach","region":"Sydney","state":"NSW","lat":-33.8915,"lon":151.2767,"offshoreWind":"W","webcams":[{"name":"Surfline","url":"https://www.surfline.com/surf-report/bondi-beach/5842041f4e65fad6a7708817"},{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/bondi-beach"},{"name":"Swellnet","url":"https://www.swellnet.com/surf-cams/bondi"}]},{"name":"Manly Beach","region":"Sydney North","state":"NSW","lat":-33.7969,"lon":151.2880,"offshoreWind":"W","webcams":[{"name":"Surfline","url":"https://www.surfline.com/surf-report/manly-beach/5842041f4e65fad6a7708819"},{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/manly"},{"name":"Manly Surf School","url":"https://www.manlysurfschool.com/surf-cam"}]},{"name":"Maroubra Beach","region":"Sydney South","state":"NSW","lat":-33.9506,"lon":151.2589,"offshoreWind":"W","webcams":[{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/maroubra"}]},{"name":"Cronulla","region":"Sydney South","state":"NSW","lat":-34.0577,"lon":151.1537,"offshoreWind":"W","webcams":[{"name":"Surfline","url":"https://www.surfline.com/surf-report/cronulla/5842041f4e65fad6a770881b"},{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/cronulla"}]},{"name":"Narrabeen","region":"Sydney North","state":"NSW","lat":-33.7118,"lon":151.2972,"offshoreWind":"W","webcams":[{"name":"Surfline","url":"https://www.surfline.com/surf-report/north-narrabeen/5842041f4e65fad6a770881a"},{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/north-narrabeen"}]},{"name":"Avalon","region":"Sydney North","state":"NSW","lat":-33.6364,"lon":151.3321,"offshoreWind":"W"},{"name":"Palm Beach","region":"Sydney North","state":"NSW","lat":-33.5989,"lon":151.3242,"offshoreWind":"W"},{"name":"Curl Curl","region":"Sydney North","state":"NSW","lat":-33.7687,"lon":151.2925,"offshoreWind":"W"},{"name":"Bronte Beach","region":"Sydney South","state":"NSW","lat":-33.9021,"lon":151.2687,"offshoreWind":"W"},{"name":"Byron Bay - The Pass","region":"North Coast","state":"NSW","lat":-28.6426,"lon":153.6119,"offshoreWind":"W","webcams":[{"name":"Surfline","url":"https://www.surfline.com/surf-report/the-pass/5842041f4e65fad6a7708976"},{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/byron-bay"}]},{"name":"Lennox Head","region":"North Coast","state":"NSW","lat":-28.7883,"lon":153.5925,"offshoreWind":"W","webcams":[{"name":"Surfline","url":"https://www.surfline.com/surf-report/lennox-head/5842041f4e65fad6a7708978"},{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/lennox-head"}]},{"name":"Angourie","region":"North Coast","state":"NSW","lat":-29.4697,"lon":153.3622,"offshoreWind":"W"},{"name":"Evans Head","region":"North Coast","state":"NSW","lat":-29.1192,"lon":153.4309,"offshoreWind":"W"},{"name":"Crescent Head","region":"Mid North Coast","state":"NSW","lat":-31.1887,"lon":152.9753,"offshoreWind":"W"},{"name":"Lighthouse Beach - Port Macquarie","region":"Mid North Coast","state":"NSW","lat":-31.4583,"lon":152.9264,"offshoreWind":"W"},{"name":"Scotts Head","region":"Mid North Coast","state":"NSW","lat":-30.7439,"lon":153.0406,"offshoreWind":"W"},{"name":"Seal Rocks","region":"Mid North Coast","state":"NSW","lat":-32.4389,"lon":152.5244,"offshoreWind":"W"},{"name":"Mollymook","region":"South Coast","state":"NSW","lat":-35.3553,"lon":150.5939,"offshoreWind":"W"},{"name":"Ulladulla","region":"South Coast","state":"NSW","lat":-35.3583,"lon":150.4750,"offshoreWind":"W"},{"name":"Snapper Rocks","region":"Gold Coast","state":"QLD","lat":-28.1756,"lon":153.5411,"offshoreWind":"W","webcams":[{"name":"Surfline","url":"https://www.surfline.com/surf-report/snapper-rocks/5842041f4e65fad6a7708982"},{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/snapper-rocks"},{"name":"Swellnet","url":"https://www.swellnet.com/surf-cams/snapper-rocks"}]},{"name":"Burleigh Heads","region":"Gold Coast","state":"QLD","lat":-28.0997,"lon":153.4503,"offshoreWind":"W","webcams":[{"name":"Surfline","url":"https://www.surfline.com/surf-report/burleigh-heads/5842041f4e65fad6a7708980"},{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/burleigh"}]},{"name":"Kirra","region":"Gold Coast","state":"QLD","lat":-28.1653,"lon":153.5353,"offshoreWind":"W","webcams":[{"name":"Surfline","url":"https://www.surfline.com/surf-report/kirra/5842041f4e65fad6a7708983"},{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/kirra"}]},{"name":"Duranbah","region":"Gold Coast","state":"QLD","lat":-28.1889,"lon":153.5500,"offshoreWind":"W"},{"name":"Noosa - First Point","region":"Sunshine Coast","state":"QLD","lat":-26.3906,"lon":153.0933,"offshoreWind":"W","webcams":[{"name":"Surfline","url":"https://www.surfline.com/surf-report/noosa-first-point/5842041f4e65fad6a7708a37"},{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/noosa"}]},{"name":"Coolum Beach","region":"Sunshine Coast","state":"QLD","lat":-26.5308,"lon":153.0892,"offshoreWind":"W"},{"name":"Mooloolaba","region":"Sunshine Coast","state":"QLD","lat":-26.6819,"lon":153.1197,"offshoreWind":"W"},{"name":"Agnes Water","region":"Central Coast","state":"QLD","lat":-24.2139,"lon":151.9064,"offshoreWind":"SW"},{"name":"Double Island Point","region":"Sunshine Coast","state":"QLD","lat":-26.0033,"lon":153.1694,"offshoreWind":"W"},{"name":"Bells Beach","region":"Torquay","state":"VIC","lat":-38.3719,"lon":144.2831,"offshoreWind":"N","webcams":[{"name":"Surfline","url":"https://www.surfline.com/surf-report/bells-beach/5842041f4e65fad6a7708b82"},{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/bells-beach"}]},{"name":"Winki Pop","region":"Torquay","state":"VIC","lat":-38.3692,"lon":144.2878,"offshoreWind":"N"},{"name":"Jan Juc","region":"Torquay","state":"VIC","lat":-38.3547,"lon":144.2972,"offshoreWind":"N"},{"name":"Thirteenth Beach","region":"Bellarine Peninsula","state":"VIC","lat":-38.2458,"lon":144.4903,"offshoreWind":"N"},{"name":"Point Leo","region":"Mornington Peninsula","state":"VIC","lat":-38.4586,"lon":145.1050,"offshoreWind":"N"},{"name":"Gunnamatta Beach","region":"Mornington Peninsula","state":"VIC","lat":-38.4833,"lon":144.9333,"offshoreWind":"N"},{"name":"Woolamai - Phillip Island","region":"Phillip Island","state":"VIC","lat":-38.5500,"lon":145.2667,"offshoreWind":"N"},{"name":"Margaret River - Main Break","region":"Margaret River","state":"WA","lat":-33.9539,"lon":115.0411,"offshoreWind":"E","webcams":[{"name":"Surfline","url":"https://www.surfline.com/surf-report/margaret-river/5842041f4e65fad6a7708d4e"},{"name":"Coastalwatch","url":"https://www.coastalwatch.com/surf-cams/margaret-river"}]},{"name":"Margaret River - The Box","region":"Margaret River","state":"WA","lat":-33.8667,"lon":114.9833,"offshoreWind":"E"},{"name":"Margaret River - North Point","region":"Margaret River","state":"WA","lat":-33.8236,"lon":114.9667,"offshoreWind":"E"},{"name":"Scarborough Beach - Perth","region":"Perth","state":"WA","lat":-31.8944,"lon":115.7617,"offshoreWind":"E"},{"name":"Trigg Beach","region":"Perth","state":"WA","lat":-31.8689,"lon":115.7586,"offshoreWind":"E"},{"name":"City Beach - Perth","region":"Perth","state":"WA","lat":-31.9375,"lon":115.7619,"offshoreWind":"E"},{"name":"Yallingup Beach","region":"South West","state":"WA","lat":-33.6442,"lon":115.0331,"offshoreWind":"E"},{"name":"Gnaraloo - Red Bluff","region":"Gascoyne","state":"WA","lat":-24.3833,"lon":113.4833,"offshoreWind":"E"},{"name":"Kalbarri","region":"Mid West","state":"WA","lat":-27.7106,"lon":114.1656,"offshoreWind":"E"},{"name":"Middleton Beach","region":"Fleurieu Peninsula","state":"SA","lat":-35.6169,"lon":138.6528,"offshoreWind":"N"},{"name":"Moana Beach","region":"Adelaide South","state":"SA","lat":-35.1333,"lon":138.4833,"offshoreWind":"E"},{"name":"Pondalowie Bay","region":"Yorke Peninsula","state":"SA","lat":-35.2333,"lon":136.6667,"offshoreWind":"N"},{"name":"Victor Harbor","region":"Fleurieu Peninsula","state":"SA","lat":-35.5528,"lon":138.6181,"offshoreWind":"N"},{"name":"Waitpinga Beach","region":"Fleurieu Peninsula","state":"SA","lat":-35.6000,"lon":138.5333,"offshoreWind":"N"},{"name":"Vivonne Bay - Kangaroo Island","region":"Kangaroo Island","state":"SA","lat":-35.9833,"lon":137.1833,"offshoreWind":"N"},{"name":"Cactus Beach","region":"Eyre Peninsula","state":"SA","lat":-32.0000,"lon":133.5167,"offshoreWind":"N"},{"name":"Shipstern Bluff","region":"Tasman Peninsula","state":"TAS","lat":-43.1833,"lon":148.0333,"offshoreWind":"NW"},{"name":"Eaglehawk Neck","region":"Tasman Peninsula","state":"TAS","lat":-43.0167,"lon":147.9333,"offshoreWind":"NW"},{"name":"Cloudy Bay","region":"South East","state":"TAS","lat":-43.3333,"lon":147.0833,"offshoreWind":"N"},{"name":"Clifton Beach","region":"Hobart","state":"TAS","lat":-42.9833,"lon":147.5167,"offshoreWind":"N"},{"name":"Marrawah","region":"North West","state":"TAS","lat":-40.9167,"lon":144.7000,"offshoreWind":"SE"}];

        let selected = null;
        let inlineSelected = null;
        let dayOffsets = {};

        // Storage
        function getL() { return JSON.parse(localStorage.getItem('locs') || '[]'); }
        function setL(l) { localStorage.setItem('locs', JSON.stringify(l)); }

        // Wind helpers
        const dirMap = {N:0,NNE:22.5,NE:45,ENE:67.5,E:90,ESE:112.5,SE:135,SSE:157.5,S:180,SSW:202.5,SW:225,WSW:247.5,W:270,WNW:292.5,NW:315,NNW:337.5};
        function deg2dir(d) {
            const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
            return dirs[Math.round(d/22.5)%16];
        }

        // Get directional arrow for wind direction
        function getWindArrow(dir) {
            const arrows = {
                'N': '‚Üë',
                'NNE': '‚Üó',
                'NE': '‚Üó',
                'ENE': '‚Üó',
                'E': '‚Üí',
                'ESE': '‚Üò',
                'SE': '‚Üò',
                'SSE': '‚Üò',
                'S': '‚Üì',
                'SSW': '‚Üô',
                'SW': '‚Üô',
                'WSW': '‚Üô',
                'W': '‚Üê',
                'WNW': '‚Üñ',
                'NW': '‚Üñ',
                'NNW': '‚Üñ'
            };
            return arrows[dir] || '‚Üí';
        }
        function quality(cur, off) {
            const diff = Math.min(Math.abs(dirMap[cur]-dirMap[off]), 360-Math.abs(dirMap[cur]-dirMap[off]));
            if(diff<=45) return 'offshore';
            if(diff<=90) return 'cross';
            return 'onshore';
        }
        function color(q, windSpeed) {
            // Base colors with intensity based on wind speed
            if (q === 'offshore') {
                // Green: lighter = better (less wind), darker = worse (more wind)
                if (windSpeed < 10) return '#4ade80'; // Light green - perfect
                if (windSpeed < 15) return '#22c55e'; // Medium green - good
                if (windSpeed < 20) return '#16a34a'; // Darker green - ok
                return '#15803d'; // Dark green - strong but offshore
            } else if (q === 'cross') {
                // Yellow/Orange: lighter = better, darker = worse
                if (windSpeed < 15) return '#fbbf24'; // Light yellow - ok
                if (windSpeed < 25) return '#f59e0b'; // Orange - getting worse
                return '#d97706'; // Dark orange - bad cross winds
            } else {
                // Red: lighter = bad, darker = terrible
                if (windSpeed < 15) return '#f87171'; // Light red - bad
                if (windSpeed < 25) return '#ef4444'; // Medium red - worse
                if (windSpeed < 35) return '#dc2626'; // Dark red - terrible
                return '#991b1b'; // Very dark red - blown out
            }
        }

        function getIcons(q, windSpeed, swellHeight) {
            let icons = '';

            if (q === 'offshore') {
                // Surf icons based on swell height (0-1m, 1-2m, 2-3m, etc)
                const surfCount = swellHeight ? Math.min(Math.ceil(swellHeight), 5) : 1;
                icons = 'üèÑ‚Äç‚ôÇÔ∏è'.repeat(surfCount);
            } else if (q === 'cross') {
                // Wave icons for cross winds based on wind speed (0-10, 10-20, 20-30)
                const waveCount = Math.min(Math.ceil(windSpeed / 10), 5);
                icons = 'üåä'.repeat(waveCount);
            } else {
                // Wind/storm icons for onshore based on wind speed
                const windCount = Math.min(Math.ceil(windSpeed / 10), 5);
                icons = 'üí®'.repeat(windCount);
            }

            return icons;
        }

        // Calculate session quality score (1-5 stars)
        function getSessionQuality(q, windSpeed, swellHeight, isDaylight) {
            let score = 0;

            // Wind quality (max 3 points)
            if (q === 'offshore') {
                if (windSpeed < 10) score += 3; // Perfect light offshore
                else if (windSpeed < 15) score += 2.5; // Good offshore
                else if (windSpeed < 20) score += 2; // Ok offshore
                else score += 1; // Strong offshore
            } else if (q === 'cross') {
                if (windSpeed < 10) score += 1.5; // Light cross
                else if (windSpeed < 15) score += 1; // Moderate cross
                else score += 0.5; // Strong cross
            } else {
                if (windSpeed < 15) score += 0.5; // Light onshore
                else score += 0; // Bad onshore
            }

            // Swell quality (max 1.5 points)
            if (swellHeight >= 1 && swellHeight <= 2.5) score += 1.5; // Perfect size
            else if (swellHeight > 0.5 && swellHeight < 3.5) score += 1; // Good size
            else if (swellHeight > 0) score += 0.5; // Some swell

            // Daylight bonus (max 0.5 points)
            if (isDaylight) score += 0.5;

            // Convert to 1-5 star rating
            return Math.max(1, Math.min(5, Math.round(score)));
        }

        function renderStars(count) {
            const full = '‚≠ê'.repeat(count);
            const empty = '‚òÜ'.repeat(5 - count);
            return full + empty;
        }

        // Fuzzy search
        function fuzzy(q, t) {
            q=q.toLowerCase(); t=t.toLowerCase();
            if(t.includes(q)) return true;
            let i=0;
            for(let c of t) if(c==q[i]) i++;
            return i==q.length;
        }

        // Wizard Search
        document.getElementById('search').addEventListener('input', e => {
            const q = e.target.value.trim();
            const r = document.getElementById('results');
            if(!q) { r.classList.remove('show'); return; }
            const m = spots.filter(s => fuzzy(q,s.name)||fuzzy(q,s.region)||fuzzy(q,s.state)).slice(0,15);
            if(!m.length) { r.innerHTML='<div class="autocomplete-item">No spots found</div>'; r.classList.add('show'); return; }
            r.innerHTML = m.map((s,i) => `<div class="autocomplete-item" data-i="${spots.indexOf(s)}"><div class="spot-name">${s.name}</div><div class="spot-details">${s.region}, ${s.state} ‚Ä¢ Offshore: ${s.offshoreWind}</div></div>`).join('');
            r.classList.add('show');
        });

        // Inline Search
        document.getElementById('inlineSearch').addEventListener('input', e => {
            const q = e.target.value.trim();
            const r = document.getElementById('inlineResults');
            if(!q) { r.classList.remove('show'); inlineSelected = null; document.getElementById('inlineAddBtn').disabled = true; return; }
            const m = spots.filter(s => fuzzy(q,s.name)||fuzzy(q,s.region)||fuzzy(q,s.state)).slice(0,15);
            if(!m.length) { r.innerHTML='<div class="autocomplete-item">No spots found</div>'; r.classList.add('show'); return; }
            r.innerHTML = m.map((s,i) => `<div class="autocomplete-item" data-i="${spots.indexOf(s)}" data-inline="true"><div class="spot-name">${s.name}</div><div class="spot-details">${s.region}, ${s.state} ‚Ä¢ Offshore: ${s.offshoreWind}</div></div>`).join('');
            r.classList.add('show');
        });

        document.addEventListener('click', e => {
            const item = e.target.closest('.autocomplete-item');
            if(item) {
                const spotData = spots[item.dataset.i];
                if(item.dataset.inline) {
                    // Inline search selection
                    inlineSelected = spotData;
                    document.getElementById('inlineSearch').value = inlineSelected.name;
                    document.getElementById('inlineResults').classList.remove('show');
                    document.getElementById('inlineAddBtn').disabled = false;
                } else {
                    // Wizard search selection
                    selected = spotData;
                    document.getElementById('search').value = selected.name;
                    document.getElementById('results').classList.remove('show');
                    document.getElementById('selName').textContent = selected.name;
                    document.getElementById('selRegion').textContent = `${selected.region}, ${selected.state}`;
                    document.getElementById('selWind').textContent = selected.offshoreWind;
                    document.getElementById('selected').classList.add('show');
                    document.getElementById('saveBtn').disabled = false;
                }
            } else if(!e.target.closest('.search-container') && !e.target.closest('.search-bar-wrapper')) {
                document.getElementById('results').classList.remove('show');
                document.getElementById('inlineResults').classList.remove('show');
            }
        });

        // Add location from inline search
        function addInline() {
            if(!inlineSelected) return;
            const locs = getL();
            if(locs.some(l => l.name==inlineSelected.name)) { alert('Already added!'); return; }
            locs.push({...inlineSelected});
            setL(locs);
            inlineSelected = null;
            document.getElementById('inlineSearch').value = '';
            document.getElementById('inlineAddBtn').disabled = true;
            renderCards();
        }

        // Save
        function save() {
            if(!selected) return;
            const locs = getL();
            if(locs.some(l => l.name==selected.name)) { alert('Already added!'); return; }
            locs.push({...selected});
            setL(locs);
            selected = null;
            document.getElementById('search').value = '';
            document.getElementById('selected').classList.remove('show');
            document.getElementById('saveBtn').disabled = true;
            showApp();
        }

        function cancel() {
            selected = null;
            document.getElementById('search').value = '';
            document.getElementById('selected').classList.remove('show');
            document.getElementById('saveBtn').disabled = true;
            showApp();
        }

        function showWizard() {
            document.getElementById('app').style.display = 'none';
            document.getElementById('wizard').style.display = 'block';
            document.getElementById('cancelBtn').classList.remove('hidden');
        }

        function showApp() {
            const locs = getL();
            if(!locs.length) {
                document.getElementById('wizard').style.display = 'block';
                document.getElementById('app').style.display = 'none';
                document.getElementById('cancelBtn').classList.add('hidden');
                return;
            }
            document.getElementById('wizard').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            renderCards();
        }

        function renderCards() {
            const locs = getL();
            const container = document.getElementById('cards');
            container.innerHTML = locs.map((loc, idx) => `
                <div class="location-card" id="card-${idx}">
                    <div class="card-header">
                        <div class="card-title">
                            <h2>
                                ${loc.name}
                                ${loc.webcams && loc.webcams.length > 0 ? '<span class="webcam-indicator" onclick="scrollToWebcam(event, ' + idx + ')" title="Webcams available">üìπ</span>' : ''}
                            </h2>
                            <p>${loc.region}, ${loc.state}</p>
                        </div>
                        <div class="card-actions">
                            <button class="icon-btn delete-btn" onclick="del(${idx})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="offshore-info">Offshore wind: <strong>${getWindArrow(loc.offshoreWind)} ${loc.offshoreWind}</strong></div>
                    ${loc.webcams && loc.webcams.length > 0 ? `
                        <div class="webcam-section">
                            <div class="webcam-title">üìπ Live Webcams</div>
                            <div class="webcam-links">
                                ${loc.webcams.map(cam => `
                                    <a href="${cam.url}" target="_blank" class="webcam-link">
                                        ${cam.name}
                                        <span style="font-size:10px">‚Üó</span>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <div class="offshore-summary" id="offshore-summary-${idx}"></div>
                    <div class="date-nav">
                        <button class="nav-btn" onclick="prevDay(${idx})">‚Üê</button>
                        <div class="current-date" id="date-${idx}">Today</div>
                        <button class="nav-btn" onclick="nextDay(${idx})">‚Üí</button>
                    </div>
                    <div class="loading" id="loading-${idx}">Loading...</div>
                    <div class="timeline hidden" id="timeline-${idx}"></div>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-icon">üí®</div><span>Onshore</span></div>
                        <div class="legend-item"><div class="legend-icon">üåä</div><span>Cross Wind</span></div>
                        <div class="legend-item"><div class="legend-icon">üèÑ‚Äç‚ôÇÔ∏è</div><span>Offshore</span></div>
                        <div class="legend-item"><div class="legend-icon">‚≠ê</div><span>Quality Score</span></div>
                        <div class="legend-item"><div class="legend-icon">üåÖ</div><span>Sunrise</span></div>
                        <div class="legend-item"><div class="legend-icon">üåá</div><span>Sunset</span></div>
                        <div class="legend-item"><div class="legend-icon">üåô</div><span>Night Hours</span></div>
                        <div class="legend-item"><div class="legend-color" style="background:#4ade80"></div><span>Light Wind</span></div>
                        <div class="legend-item"><div class="legend-color" style="background:#f59e0b"></div><span>Moderate Wind</span></div>
                        <div class="legend-item"><div class="legend-color" style="background:#dc2626"></div><span>Strong Wind</span></div>
                    </div>
                </div>
            `).join('');
            locs.forEach((loc, idx) => {
                if(!dayOffsets[idx]) dayOffsets[idx] = 0;
                loadWind(loc, idx);
            });
        }

        async function loadWind(loc, idx) {
            const offset = dayOffsets[idx] || 0;
            const date = new Date();
            date.setDate(date.getDate() + offset);

            document.getElementById(`loading-${idx}`).classList.remove('hidden');
            document.getElementById(`timeline-${idx}`).classList.add('hidden');

            // Update date display
            const dateStr = offset==0 ? 'Today' : offset==1 ? 'Tomorrow' : offset==-1 ? 'Yesterday' : date.toLocaleDateString('en-US', {month:'short', day:'numeric'});
            document.getElementById(`date-${idx}`).textContent = dateStr;

            try {
                // Fetch data for 3 days: previous, current, next
                const prevDate = new Date(date);
                prevDate.setDate(prevDate.getDate() - 1);
                const nextDate = new Date(date);
                nextDate.setDate(nextDate.getDate() + 1);

                const dateParam = date.toISOString().split('T')[0];
                const prevDateParam = prevDate.toISOString().split('T')[0];
                const nextDateParam = nextDate.toISOString().split('T')[0];

                // Use marine API for surf data (swell, wave height, etc)
                const url = `https://marine-api.open-meteo.com/v1/marine?latitude=${loc.lat}&longitude=${loc.lon}&hourly=wave_height,wave_direction,wave_period,wind_wave_height,swell_wave_height&start_date=${dateParam}&end_date=${dateParam}&timezone=auto`;
                const windUrl = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&hourly=wind_speed_10m,wind_direction_10m,temperature_2m,weather_code&daily=sunrise,sunset&start_date=${dateParam}&end_date=${dateParam}&timezone=auto`;

                // Previous day
                const prevUrl = `https://marine-api.open-meteo.com/v1/marine?latitude=${loc.lat}&longitude=${loc.lon}&hourly=wave_height,wave_direction,wave_period,wind_wave_height,swell_wave_height&start_date=${prevDateParam}&end_date=${prevDateParam}&timezone=auto`;
                const prevWindUrl = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&hourly=wind_speed_10m,wind_direction_10m&start_date=${prevDateParam}&end_date=${prevDateParam}&timezone=auto`;

                // Next day
                const nextUrl = `https://marine-api.open-meteo.com/v1/marine?latitude=${loc.lat}&longitude=${loc.lon}&hourly=wave_height,wave_direction,wave_period,wind_wave_height,swell_wave_height&start_date=${nextDateParam}&end_date=${nextDateParam}&timezone=auto`;
                const nextWindUrl = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&hourly=wind_speed_10m,wind_direction_10m&start_date=${nextDateParam}&end_date=${nextDateParam}&timezone=auto`;

                console.log(`Fetching data for ${loc.name}`);

                const [windRes, marineRes, prevWindRes, prevMarineRes, nextWindRes, nextMarineRes] = await Promise.all([
                    fetch(windUrl), fetch(url),
                    fetch(prevWindUrl), fetch(prevUrl),
                    fetch(nextWindUrl), fetch(nextUrl)
                ]);

                const windData = await windRes.json();
                const marineData = await marineRes.json();
                const prevWindData = await prevWindRes.json();
                const prevMarineData = await prevMarineRes.json();
                const nextWindData = await nextWindRes.json();
                const nextMarineData = await nextMarineRes.json();

                console.log(`Data for ${loc.name}:`, {wind: windData, marine: marineData});

                if (!windData.hourly || !windData.hourly.wind_direction_10m || !windData.hourly.wind_speed_10m) {
                    throw new Error('Invalid wind data');
                }

                document.getElementById(`loading-${idx}`).classList.add('hidden');
                document.getElementById(`timeline-${idx}`).classList.remove('hidden');

                const timeline = document.getElementById(`timeline-${idx}`);
                timeline.innerHTML = '';

                const now = new Date();
                const currentHour = offset === 0 ? now.getHours() : -1;

                // Get sunrise and sunset times from API (in location's local timezone)
                const sunriseTime = new Date(windData.daily.sunrise[0]);
                const sunsetTime = new Date(windData.daily.sunset[0]);
                const sunriseHour = sunriseTime.getHours();
                const sunriseMinute = sunriseTime.getMinutes();
                const sunsetHour = sunsetTime.getHours();
                const sunsetMinute = sunsetTime.getMinutes();

                console.log(`${loc.name} sun times:`, {
                    sunrise: `${sunriseHour}:${sunriseMinute.toString().padStart(2, '0')}`,
                    sunset: `${sunsetHour}:${sunsetMinute.toString().padStart(2, '0')}`
                });

                let nextOffshore = null;
                let offshoreHours = [];
                let offshoreStart = null;

                // Build timeline entries array (will include both hours and sun events)
                let timelineEntries = [];

                for(let i=0; i<24; i++) {
                    const windDir = windData.hourly.wind_direction_10m[i];
                    const windSpeed = windData.hourly.wind_speed_10m[i];

                    if (windDir === null || windDir === undefined || windSpeed === null || windSpeed === undefined) {
                        console.warn(`Missing data for hour ${i} at ${loc.name}`);
                        continue;
                    }

                    const dir = deg2dir(windDir);
                    const speed = Math.round(windSpeed);
                    const q = quality(dir, loc.offshoreWind);
                    const hourTime = new Date(windData.hourly.time[i]);
                    const h = hourTime.getHours();
                    const timeStr = h==0?'12am':h<12?`${h}am`:h==12?'12pm':`${h-12}pm`;

                    // Get marine data (with fallback)
                    const waveHeight = marineData.hourly?.wave_height?.[i] || marineData.hourly?.swell_wave_height?.[i];
                    const wavePeriod = marineData.hourly?.wave_period?.[i];
                    const swellHeight = marineData.hourly?.swell_wave_height?.[i];

                    // Color based on quality AND wind speed
                    const c = color(q, speed);

                    // Swell info text
                    let swellText = '';
                    if (waveHeight !== null && waveHeight !== undefined) {
                        swellText = `${waveHeight.toFixed(1)}m`;
                        if (wavePeriod) swellText += ` ‚Ä¢ ${Math.round(wavePeriod)}s`;
                    }

                    // Dynamic icons based on conditions
                    const icons = getIcons(q, speed, waveHeight || swellHeight || 1);

                    // Check if this hour is during night time
                    const isNight = h < sunriseHour || h >= sunsetHour;
                    const isDaylight = !isNight;

                    // Calculate session quality
                    const sessionQuality = getSessionQuality(q, speed, waveHeight || swellHeight || 1, isDaylight);
                    const stars = renderStars(sessionQuality);

                    // Track offshore hours with window detection
                    if(q === 'offshore') {
                        if(!offshoreStart) offshoreStart = timeStr;
                        offshoreHours.push({hour: h, time: timeStr, dir, speed, waveHeight});
                    } else {
                        if(offshoreStart && offshoreHours.length > 0) {
                            // Window ended
                            offshoreStart = null;
                        }
                    }

                    // Find next offshore window (only future hours if today)
                    if(!nextOffshore && q==='offshore' && h >= currentHour) {
                        // Find when this window ends
                        let endIdx = i;
                        for(let j = i+1; j < 24; j++) {
                            const nextDir = deg2dir(windData.hourly.wind_direction_10m[j]);
                            const nextQ = quality(nextDir, loc.offshoreWind);
                            if(nextQ !== 'offshore') break;
                            endIdx = j;
                        }
                        const endH = new Date(windData.hourly.time[endIdx]).getHours();
                        const endTimeStr = endH==0?'12am':endH<12?`${endH}am`:endH==12?'12pm':`${endH-12}pm`;

                        nextOffshore = {
                            time: timeStr,
                            endTime: endTimeStr,
                            duration: endIdx - i + 1,
                            dir,
                            speed,
                            waveHeight,
                            date: offset==0?'Today':offset==1?'Tomorrow':offset==-1?'Yesterday':dateStr
                        };
                    }

                    // Determine if hour is pre-sunrise or post-sunset
                    const isPreSunrise = h < sunriseHour;
                    const isPostSunset = h >= sunsetHour;
                    const nightClass = isPreSunrise ? 'pre-sunrise' : isPostSunset ? 'post-sunset' : '';

                    // Add hour entry to timeline
                    timelineEntries.push({
                        type: 'hour',
                        hour: h,
                        sortKey: h,
                        isNight: isNight,
                        isPreSunrise: isPreSunrise,
                        isPostSunset: isPostSunset,
                        html: `
                            <div class="hour-row ${isNight ? 'night-period' : ''} ${nightClass} ${nightClass ? 'collapsed' : ''}" data-card="${idx}">
                                <div class="time-label">${timeStr}</div>
                                <div class="wind-bar" style="background:${c}">
                                    <div class="session-stars">${stars}</div>
                                    <div class="left">
                                        <span style="font-size:14px">${icons}</span>
                                        <span style="font-size:13px">${dir} ${speed}km/h</span>
                                    </div>
                                    <div class="right">
                                        ${swellText ? `<div class="swell-info"><div>${swellText}</div></div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `
                    });
                }

                // Add sunrise event
                const sunriseTimeStr = sunriseHour==0?'12am':sunriseHour<12?`${sunriseHour}am`:sunriseHour==12?'12pm':`${sunriseHour-12}pm`;
                timelineEntries.push({
                    type: 'sunrise',
                    hour: sunriseHour,
                    sortKey: sunriseHour + (sunriseMinute / 60),
                    html: `
                        <div class="sun-event sunrise" onclick="togglePreSunrise(${idx})" id="sunrise-${idx}">
                            <div class="toggle-icon left" id="sunrise-toggle-left-${idx}">‚ñº</div>
                            <div class="sun-icon">üåÖ</div>
                            <div class="sun-label">Sunrise ${sunriseTimeStr} (${sunriseMinute.toString().padStart(2, '0')}min)</div>
                            <div class="toggle-icon right" id="sunrise-toggle-right-${idx}">‚ñº</div>
                        </div>
                    `
                });

                // Add sunset event
                const sunsetTimeStr = sunsetHour==0?'12am':sunsetHour<12?`${sunsetHour}am`:sunsetHour==12?'12pm':`${sunsetHour-12}pm`;
                timelineEntries.push({
                    type: 'sunset',
                    hour: sunsetHour,
                    sortKey: sunsetHour + (sunsetMinute / 60),
                    html: `
                        <div class="sun-event sunset" onclick="togglePostSunset(${idx})" id="sunset-${idx}">
                            <div class="toggle-icon left" id="sunset-toggle-left-${idx}">‚ñº</div>
                            <div class="sun-icon">üåá</div>
                            <div class="sun-label">Sunset ${sunsetTimeStr} (${sunsetMinute.toString().padStart(2, '0')}min)</div>
                            <div class="toggle-icon right" id="sunset-toggle-right-${idx}">‚ñº</div>
                        </div>
                    `
                });

                // Sort entries by time and render
                timelineEntries.sort((a, b) => a.sortKey - b.sortKey);
                timeline.innerHTML = timelineEntries.map(entry => entry.html).join('');

                console.log(`${loc.name} timeline entries:`, timelineEntries.length);

                console.log(`${loc.name} offshore hours:`, offshoreHours);

                // Helper function to calculate offshore windows from wind data
                function calculateOffshoreWindows(windDataDay, marineDataDay, offshoreWindDir) {
                    const offshoreHours = [];

                    if(!windDataDay.hourly || !windDataDay.hourly.wind_direction_10m || !windDataDay.hourly.wind_speed_10m) {
                        return null;
                    }

                    for(let i=0; i<24; i++) {
                        const windDir = windDataDay.hourly.wind_direction_10m[i];
                        const windSpeed = windDataDay.hourly.wind_speed_10m[i];

                        if (windDir === null || windDir === undefined || windSpeed === null || windSpeed === undefined) {
                            continue;
                        }

                        const dir = deg2dir(windDir);
                        const q = quality(dir, offshoreWindDir);
                        const hourTime = new Date(windDataDay.hourly.time[i]);
                        const h = hourTime.getHours();
                        const timeStr = h==0?'12am':h<12?`${h}am`:h==12?'12pm':`${h-12}pm`;
                        const waveHeight = marineDataDay.hourly?.wave_height?.[i] || marineDataDay.hourly?.swell_wave_height?.[i];

                        if(q === 'offshore') {
                            offshoreHours.push({hour: h, time: timeStr, dir, speed: Math.round(windSpeed), waveHeight});
                        }
                    }

                    if(offshoreHours.length === 0) return null;

                    // Calculate window summary
                    const avgWave = offshoreHours.reduce((sum, oh) => sum + (oh.waveHeight || 0), 0) / offshoreHours.length;
                    return {
                        count: offshoreHours.length,
                        startTime: offshoreHours[0].time,
                        endTime: offshoreHours[offshoreHours.length - 1].time,
                        avgWave: avgWave > 0 ? avgWave : null,
                        hours: offshoreHours
                    };
                }

                // Calculate offshore windows for 3-column display
                // 1. Previous day's offshore windows
                let previousWindow = null;
                const prevDayWindows = calculateOffshoreWindows(prevWindData, prevMarineData, loc.offshoreWind);
                if(prevDayWindows) {
                    const prevOffset = offset - 1;
                    const prevDateLabel = prevOffset === 0 ? 'Today' :
                                          prevOffset === 1 ? 'Tomorrow' :
                                          prevOffset === -1 ? 'Yesterday' :
                                          prevDate.toLocaleDateString('en-GB', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\//g, '/');

                    previousWindow = {
                        ...prevDayWindows,
                        date: prevDateLabel
                    };
                }

                // 2. Current day's offshore windows (all windows for the viewed day)
                let currentDayWindows = null;
                if(offshoreHours.length > 0) {
                    const firstWindow = offshoreHours[0];
                    const lastWindow = offshoreHours[offshoreHours.length - 1];
                    const avgWave = offshoreHours.reduce((sum, oh) => sum + (oh.waveHeight || 0), 0) / offshoreHours.length;
                    const currentDateLabel = offset === 0 ? 'Today' :
                                            offset === 1 ? 'Tomorrow' :
                                            offset === -1 ? 'Yesterday' :
                                            date.toLocaleDateString('en-GB', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\//g, '/');

                    currentDayWindows = {
                        count: offshoreHours.length,
                        startTime: firstWindow.time,
                        endTime: lastWindow.time,
                        avgWave: avgWave > 0 ? avgWave : null,
                        date: currentDateLabel
                    };
                }

                // 3. Next day's offshore windows
                let nextDayWindow = null;
                const nextDayWindows = calculateOffshoreWindows(nextWindData, nextMarineData, loc.offshoreWind);
                if(nextDayWindows) {
                    const nextOffset = offset + 1;
                    const nextDateLabel = nextOffset === 0 ? 'Today' :
                                         nextOffset === 1 ? 'Tomorrow' :
                                         nextOffset === -1 ? 'Yesterday' :
                                         nextDate.toLocaleDateString('en-GB', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\//g, '/');

                    nextDayWindow = {
                        ...nextDayWindows,
                        date: nextDateLabel
                    };
                }

                // Render 3-column summary
                const summaryEl = document.getElementById(`offshore-summary-${idx}`);
                let summaryHTML = '';

                // Column 1: Previous Day
                summaryHTML += '<div class="offshore-column ' + (previousWindow ? 'previous' : 'none') + '">';
                summaryHTML += '<div class="offshore-column-title">‚èÆ Previous Day</div>';
                if(previousWindow) {
                    if(previousWindow.date !== 'Today') {
                        summaryHTML += `<div class="offshore-column-time" style="font-size:10px;margin-bottom:2px">${previousWindow.date}</div>`;
                    }
                    summaryHTML += `<div class="offshore-column-time">${previousWindow.startTime} - ${previousWindow.endTime}</div>`;
                    const waveInfo = previousWindow.avgWave ? ` ‚Ä¢ ${previousWindow.avgWave.toFixed(1)}m` : '';
                    summaryHTML += `<div class="offshore-column-details">${previousWindow.count} hour${previousWindow.count > 1 ? 's' : ''}${waveInfo}</div>`;
                } else {
                    summaryHTML += '<div class="offshore-column-time">‚Äî</div>';
                    summaryHTML += '<div class="offshore-column-details">No offshore winds</div>';
                }
                summaryHTML += '</div>';

                // Column 2: Current Day
                summaryHTML += '<div class="offshore-column ' + (currentDayWindows ? 'today' : 'none') + '">';
                summaryHTML += '<div class="offshore-column-title">üìç Current Day</div>';
                if(currentDayWindows) {
                    if(currentDayWindows.date !== 'Today') {
                        summaryHTML += `<div class="offshore-column-time" style="font-size:10px;margin-bottom:2px">${currentDayWindows.date}</div>`;
                    }
                    summaryHTML += `<div class="offshore-column-time">${currentDayWindows.startTime} - ${currentDayWindows.endTime}</div>`;
                    const waveInfo = currentDayWindows.avgWave ? ` ‚Ä¢ ${currentDayWindows.avgWave.toFixed(1)}m` : '';
                    summaryHTML += `<div class="offshore-column-details">${currentDayWindows.count} hour${currentDayWindows.count > 1 ? 's' : ''}${waveInfo}</div>`;
                } else {
                    summaryHTML += '<div class="offshore-column-time">‚Äî</div>';
                    summaryHTML += '<div class="offshore-column-details">No offshore winds</div>';
                }
                summaryHTML += '</div>';

                // Column 3: Next Day
                summaryHTML += '<div class="offshore-column ' + (nextDayWindow ? 'next' : 'none') + '">';
                summaryHTML += '<div class="offshore-column-title">‚è≠ Next Day</div>';
                if(nextDayWindow) {
                    if(nextDayWindow.date !== 'Today') {
                        summaryHTML += `<div class="offshore-column-time" style="font-size:10px;margin-bottom:2px">${nextDayWindow.date}</div>`;
                    }
                    summaryHTML += `<div class="offshore-column-time">${nextDayWindow.startTime} - ${nextDayWindow.endTime}</div>`;
                    const swellInfo = nextDayWindow.avgWave ? ` ‚Ä¢ ${nextDayWindow.avgWave.toFixed(1)}m` : '';
                    summaryHTML += `<div class="offshore-column-details">${nextDayWindow.count} hour${nextDayWindow.count > 1 ? 's' : ''}${swellInfo}</div>`;
                } else {
                    summaryHTML += '<div class="offshore-column-time">‚Äî</div>';
                    summaryHTML += '<div class="offshore-column-details">No offshore winds</div>';
                }
                summaryHTML += '</div>';

                summaryEl.innerHTML = summaryHTML;
            } catch(e) {
                console.error(`Error loading wind data for ${loc.name}:`, e);
                document.getElementById(`loading-${idx}`).classList.add('hidden');
                document.getElementById(`timeline-${idx}`).classList.remove('hidden');
                document.getElementById(`timeline-${idx}`).innerHTML = `<div style="text-align:center;padding:20px;color:#dc3545">Error loading data. Please try again.</div>`;
            }
        }

        function prevDay(idx) {
            dayOffsets[idx] = (dayOffsets[idx]||0) - 1;
            if(dayOffsets[idx] < -7) dayOffsets[idx] = -7;
            const locs = getL();
            loadWind(locs[idx], idx);
        }

        function nextDay(idx) {
            dayOffsets[idx] = (dayOffsets[idx]||0) + 1;
            if(dayOffsets[idx] > 7) dayOffsets[idx] = 7;
            const locs = getL();
            loadWind(locs[idx], idx);
        }

        function del(idx) {
            const locs = getL();
            if(confirm(`Delete ${locs[idx].name}?`)) {
                locs.splice(idx, 1);
                setL(locs);
                delete dayOffsets[idx];
                renderCards();
                if(!locs.length) showApp();
            }
        }

        function clearAll() {
            if(confirm('Clear all locations?')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Toggle pre-sunrise hours
        function togglePreSunrise(idx) {
            const timeline = document.getElementById(`timeline-${idx}`);
            const preSunriseHours = timeline.querySelectorAll('.pre-sunrise');
            const toggleIconLeft = document.getElementById(`sunrise-toggle-left-${idx}`);
            const toggleIconRight = document.getElementById(`sunrise-toggle-right-${idx}`);

            preSunriseHours.forEach(hour => {
                hour.classList.toggle('collapsed');
            });

            // Update icons
            const iconText = preSunriseHours[0]?.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
            toggleIconLeft.textContent = iconText;
            toggleIconRight.textContent = iconText;
        }

        // Toggle post-sunset hours
        function togglePostSunset(idx) {
            const timeline = document.getElementById(`timeline-${idx}`);
            const postSunsetHours = timeline.querySelectorAll('.post-sunset');
            const toggleIconLeft = document.getElementById(`sunset-toggle-left-${idx}`);
            const toggleIconRight = document.getElementById(`sunset-toggle-right-${idx}`);

            postSunsetHours.forEach(hour => {
                hour.classList.toggle('collapsed');
            });

            // Update icons
            const iconText = postSunsetHours[0]?.classList.contains('collapsed') ? '‚ñº' : '‚ñ≤';
            toggleIconLeft.textContent = iconText;
            toggleIconRight.textContent = iconText;
        }

        // Scroll to webcam section
        function scrollToWebcam(event, idx) {
            event.preventDefault();
            event.stopPropagation();
            const card = document.getElementById(`card-${idx}`);
            const webcamSection = card.querySelector('.webcam-section');
            if (webcamSection) {
                webcamSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                // Add a brief highlight effect
                webcamSection.style.transition = 'all 0.3s';
                webcamSection.style.transform = 'scale(1.02)';
                webcamSection.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                setTimeout(() => {
                    webcamSection.style.transform = 'scale(1)';
                    webcamSection.style.boxShadow = 'none';
                }, 300);
            }
        }

        // Init
        document.getElementById('status').textContent = `${spots.length} spots loaded ‚úì`;
        document.getElementById('status').style.color = '#28a745';
        showApp();
    </script>
</body>
</html>